<!DOCTYPE html>
<html>
<head>
	<title>Wheelway Map</title>
	<!--Bootstrap-->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<!--jQuery-->
	<script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
	<!--Leaflet CSS-->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin="" />
   	<!--Leaflet script-->
	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
	<!--Leaflet Draw CSS-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css"/>
	<!--Leaflet Draw script-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>
    <!--Leaflet MakiMarkers script-->
    <script src="Leaflet.MakiMarkers.js"></script>

    <style>
    	#map {
    	 height: 500px;
    	 width: 900px;
    	 margin-left: auto; 
    	 margin-right:auto;
    	}
    	/* Red marker (toolbar) */
 		.leaflet-draw-toolbar .leaflet-draw-draw-R { 
		 background: url(data:image/svg+xml;utf8,
		 	<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20'>
    	 	<circle cx='5' cy='5' r='5' />
		 	</svg>) no-repeat; 
		 background-color: rgba(244, 67, 54, 0.7);
		}
		/*green marker (toolbar) */
		.leaflet-draw-toolbar .leaflet-draw-draw-G {
		 background: url(data:image/svg+xml;utf8,
		 	<svg xmlns='http://www.w3.org/2000/svg' width='20' height='20'>
    	 	<circle cx='5' cy='5' r='5' />
		 	</svg>) no-repeat;
		 background-color: rgba(76, 175, 80, 0.7);
		}
    </style>
</head>
<body>
<!--Map container-->
<div id="map"></div>

<!--Script-->
<script>
	// Initializing map and setting view to chosen geographical coordinates and a zoom level
		// ** TODO: Set default view to IP address of current user
	var map = L.map('map').setView([30.307182, -97.755996], 12); // Austin, TX

	// Adding Mapbox Streets tile layer
	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', 
		{ attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>', 
		maxZoom: 18, 
		id: 'mapbox.streets', 
		accessToken: 'pk.eyJ1Ijoic3p1bmppYyIsImEiOiJjamE1a3FudDY0bHI2MnBwb2d5eTNueWs1In0.kbvyZYrCsTeQP4yvdWCdig'
	}).addTo(map);

	// MakiMarkers (Map icons)
		// ** Must npm install for this to work
	L.MakiMarkers.accessToken 
	= "pk.eyJ1Ijoic3p1bmppYyIsImEiOiJjamE1a3FudDY0bHI2MnBwb2d5eTNueWs1In0.kbvyZYrCsTeQP4yvdWCdig";

	var obstructionIcon = L.MakiMarkers.icon({icon: "roadblock", color: "#f44336", size: "l"});
	var supportIcon = L.MakiMarkers.icon({icon: "disability", color: "#4caf50", size: "l"});

// Creating temp layer to store new features ** I think this is unecessary; keeping here just in case.
	// var drawnItems = new L.FeatureGroup();
	// map.addLayer(drawnItems); 

    // Red marker (obstruction)
    L.Draw.MarkerR = L.Draw.Marker.extend({
    	initialize: function (map, options) {
      		this.type = 'R';

      		L.Draw.Feature.prototype.initialize.call(this, map, options);
    	},

    	addHooks: function () {
      		L.Draw.Marker.prototype.addHooks.call(this);
			
			if (this._map) {
        		this._tooltip.updateContent({ text: 'Click to place an obstruction marker.' });
      		}
    	}
	});

	// Green marker (support)
	L.Draw.MarkerG = L.Draw.Marker.extend({
		initialize: function (map, options) {
			this.type = 'G';

			L.Draw.Feature.prototype.initialize.call(this, map, options);
    	},

		addHooks: function () {
			L.Draw.Marker.prototype.addHooks.call(this);

      		if (this._map) {
        		this._tooltip.updateContent({ text: 'Click to place a support marker.' });
      		}
    	}
	});

	// Hacking up L.DrawToolbar.getModeHandlers to include the 2 new versions of the marker handler
	L.DrawToolbar.include({
		getModeHandlers: function (map) {
			return [
				{
					enabled: true,
                	handler: new L.Draw.MarkerR(map, { icon: obstructionIcon }),
					// Leaflet default blue marker: { icon: new L.Icon.Default() })
					title: 'Obstruction'
				},
				{
					enabled: true,
					handler: new L.Draw.MarkerG(map, { icon: supportIcon }),
					// Leaflet default blue marker: { icon: new L.Icon.Default() })
					title: 'Support'
				},
			];
		}
	});

	// Creating draw controls and toolbar
	var drawControl = new L.Control.Draw({
		draw: {
			position: 'topleft',
		},
		edit: false
	});
	map.addControl(drawControl);



// Custom functions upon 'edit' (when user clicks map to place marker)
	map.on('draw:created', function(e) {  

  		var coords = e.layer._latlng;  	
		
		console.log("Marker layer type: " + e.layerType);
		console.log(this);

		var tempMarker;

		var markerTypesForm;

		switch (e.layerType) {
			case 'R': // If a red (R) marker is placed
				tempMarker = L.marker(coords, { icon: obstructionIcon });
				markerTypesForm = 
				'<div class="form-group">'+
					'<label class="control-label col-sm-5"><strong>Obstruction Type: </strong></label>'+
					'<select class="form-control" id="marker-type" name="marker-type">'+
		            	'<option value="barrier">Barrier</option>'+
		            	'<option value="construction">Construction</option>'+
		            	'<option value="curb">Curb</option>'+
		            	'<option value="stairs">Stairs</option>'+
		            	'<option value="rough-road">Rough road</option>'+
	          		'</select>'+ 
				'</div>'
			break;

			case 'G': // If a green (G) marker is placed
				tempMarker = L.marker(coords, { icon: supportIcon });
				markerTypesForm = 
				'<div class="form-group">'+
					'<label class="control-label col-sm-5"><strong>Support Type: </strong></label>'+
					'<select class="form-control" id="marker-type" name="marker-type">'+
		            	'<option value="curb-cut">Curb cut</option>'+
		            	'<option value="ramp">Ramp</option>'+
		            	'<option value="elevator">Elevator</option>'+
	          		'</select>'+ 
				'</div>'		
		};

		// Old code; keeping here just in case
    	// var coords = e.layer._latlng;
    	// tempMarker = drawnItems.addLayer(e.layer);
		
		var popupContent = 
			'<form role="form" id="form" enctype="multipart/form-data" class="form-horizontal" onsubmit="addMarker()">'+
	        
	        // Date
	        '<div class="form-group">'+
				'<label class="control-label col-sm-5"><strong>Date: </strong></label>'+
				'<input type="date" placeholder="Required" id="date" name="date" class="form-control"/>'+ 
			'</div>'+

			// Type of marker
			markerTypesForm +

			// Description (optional)
	        '<div class="form-group">'+
				'<label class="control-label col-sm-5"><strong>Description (optional): </strong></label>'+
				'<textarea class="form-control" rows="6" id="description" name="description"></textarea>'+
			'</div>'+

			// Location coordinates (not seen)
			'<input style="display: none;" type="text" id="lat" name="lat" value="'+coords.lat.toFixed(6)+'" />'+
			'<input style="display: none;" type="text" id="lng" name="lng" value="'+coords.lng.toFixed(6)+'" />'+

			// Submit & cancel buttons
			'<div class="form-group">'+
				'<div class="col-xs-6"><button type="button" class="btn btn-primary" id="cancel-btn">Cancel</button></div>'+
				'<div class="col-xs-6"><button type="submit" value="submit" class="btn btn-primary trigger-submit">Submit</button></div>'+
			'</div>'+

	    	'</form>';

		tempMarker
		.bindPopup(popupContent,
		{
			keepInView: true,
      		closeButton: true 
    	})
    	.addTo(map)
    	.openPopup()
    	// .onClick marker for testing
    	.on('click', function() { 
    		console.log(this);
    		console.log("Marker layer type: " + e.layerType); 
    	})
    	

		// ** TODO: Cancel form button deletes marker

		// Cancel form button (deletes marker)
		$("#cancel-btn").click(function() {
			console.log("clicked");
			map.removeLayer(tempMarker);


		})

		// ** TODO: Submit form button 
			// Save user input (date, location, type of marker, and description) to database

		// Submit form button 
		$("#form").submit(function(e){
			e.preventDefault();
			// addMarker();
			var date = $("#date").val().trim();
			var markerType = $("#marker-type").val().trim();
			var description = $("#description").val().trim();
			var lat = $("#lat").val().trim();
			var lng = $("#lng").val().trim();
			console.log("Date: " + date);
			console.log("Marker type: " + markerType);
			console.log("Description: " + description);
			console.log("Lat: " + lat);
			console.log("Lng: " + lng);


		// ** TODO:
			// Delete the old marker icon 
			// Send back specific custom marker based on the TYPE valye from user input 
				// Send back as argument ?
			// Save the new specific custom marker at the location 
				// Informational pop-up when clicked 
		});
	});

</script>


</body>
</html>